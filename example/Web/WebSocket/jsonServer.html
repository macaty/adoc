
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="robots" content="index, follow">
<meta name='description' content='aardio ç¼–ç¨‹è¯­è¨€èŒƒä¾‹ - HTTP/WebSocket/JSON-RPC ä¸‰åˆä¸€ä½“æœåŠ¡ç«¯'>
<meta http-equiv='content-language' content='zh-cn'>
<title>aardio ç¼–ç¨‹è¯­è¨€èŒƒä¾‹ - HTTP/WebSocket/JSON-RPC ä¸‰åˆä¸€ä½“æœåŠ¡ç«¯</title> 
<link rel="stylesheet" href="../../../css/markdown.css" tppabs="https://www.aardio.com/zh-cn/doc/css/markdown.css">
<script src="../../../js/prism.js" tppabs="https://www.aardio.com/zh-cn/doc/js/prism.js"></script>
<link rel="stylesheet" href="../../../../../../lib.baomitu.com/font-awesome/6.6.0/css/fontawesome.min.css" tppabs="https://lib.baomitu.com/font-awesome/6.6.0/css/fontawesome.min.css">
<link rel="stylesheet" href="../../../../../../lib.baomitu.com/font-awesome/6.6.0/css/solid.min.css" tppabs="https://lib.baomitu.com/font-awesome/6.6.0/css/solid.min.css">
</head>
<body class="markdown-body"><a id="back-to-home" href="../../../index.htm" tppabs="https://www.aardio.com/zh-cn/doc/" title="aardio ç¼–ç¨‹è¯­è¨€æ–‡æ¡£é¦–é¡µ"><i class="fas fa-home" id="home-icon"></i><i class="fas fa-robot" id="ai-icon" style="display: none;"></i><span id="aardio-document-home">aardio æ–‡æ¡£</span></a>
<h1>aardio èŒƒä¾‹: HTTP/WebSocket/JSON-RPC ä¸‰åˆä¸€ä½“æœåŠ¡ç«¯</h1><pre><code class="aardio language-aardio">//WS-JSON-RPCæœåŠ¡ç«¯

import win.ui;
/*DSG{{*/
var winform = win.form(text=&quot;HTTP/WebSocket/JSON-RPC ä¸‰åˆä¸€ä½“æœåŠ¡ç«¯&quot;;left=10;top=4;right=774;bottom=467)
winform.add(
btnPublish={cls=&quot;button&quot;;text=&quot;ç¾¤å‘é€šçŸ¥æ¶ˆæ¯&quot;;left=505;top=411;right=621;bottom=450;db=1;dr=1;z=2};
btnSurvey={cls=&quot;button&quot;;text=&quot;å‘èµ·è°ƒæŸ¥ä»»åŠ¡&quot;;left=633;top=408;right=746;bottom=449;db=1;dr=1;z=3};
txtMessage={cls=&quot;edit&quot;;left=29;top=22;right=741;bottom=389;db=1;dl=1;dr=1;dt=1;edge=1;multiline=1;z=1}
)
/*}}*/

//åˆ›å»ºWebSocketæœåŠ¡ç«¯
import web.socket.server;
var wsrv = web.socket.server();

//åˆ›å»ºJSON-RPCæœåŠ¡ç«¯
import web.socket.jsonServer;
var rpcServer = web.socket.jsonServer(wsrv);

//æŒ‡å®šå®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨çš„å¯¹è±¡å’Œæ–¹æ³•
rpcServer.external ={

    /*
    å¦‚æœå‡½æ•°åé¦–å­—ç¬¦ä¸º$ï¼Œç¬¬ä¸€ä¸ªå›è°ƒå‚æ•°ä¸º$( è¡¨ç¤ºå½“å‰å®¢æˆ·ç«¯å¥—æ¥å­—å¥æŸ„ )ã€‚
    */
    $hello = function($,name){
        return &quot;hello &quot; + name;
    }

    aardio= {

        hello = function(name){
            return &quot;aardio.hello &quot; + name;
        }
    }
} 

//å®¢æˆ·ç«¯ä½¿ç”¨HTTPè¯·æ±‚åˆ‡æ¢åˆ°WebSocketåè®®
wsrv.onUpgradeToWebsocket = function(hSocket,request,response,protocol,origin){    
    if( request.path == &quot;/jsonrpc&quot; ){
        //å…è®¸æŒ‡å®šçš„å¥—æ¥å­—å¼€å¯JSON-RPCæœåŠ¡
        return rpcServer.start(hSocket);
    } 

    //ç¦æ­¢è®¿é—®å…¶ä»–åœ°å€
    response.close();
}

//ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥è¿‡æ¥äº†
wsrv.onOpen = function(hSocket){ 
    var client = wsrv.client(hSocket);
    if(client)  winform.txtMessage.print(&quot;å®¢æˆ·ç«¯å·²è¿æ¥&quot;, client.getRemoteIp() ); 
    rpcServer.notify(hSocket,&quot;hello&quot;,&quot;æœåŠ¡ç«¯é€šçŸ¥&quot;);
}

//ä¸€ä¸ªå®¢æˆ·ç«¯æ‰çº¿äº†
wsrv.onClose = function(hSocket){
    winform.txtMessage.print(&quot;å®¢æˆ·ç«¯å·²æ–­çº¿&quot;,hSocket);
}

//ä¸€ä¸ªå®¢æˆ·ç«¯å‡ºé”™äº†
wsrv.onError = function(hSocket,err){
    winform.txtMessage.print(&quot;å‡ºé”™äº†&quot;,hSocket,err);
}

//ä¸€ä¸ªå®¢æˆ·ç«¯å‘æ¶ˆæ¯è¿‡æ¥äº†
wsrv.onMessage = function(hSocket,msg){
    winform.txtMessage.print(hSocket,msg.data); 
    wsrv.send(hSocket,&quot;WebSocketå®¢æˆ·ç«¯ï¼Œæ”¶åˆ°äº†ä½ å‘è¿‡æ¥çš„æ¶ˆæ¯ï¼š&quot; + msg.data) 
}

//å¯åŠ¨æœåŠ¡ç«¯ 
if( wsrv.start(,8879) ){
    winform.txtMessage.print( wsrv.getUrl(&quot;jsonrpc&quot;),&quot;å·²å¯åŠ¨ WebSocket/JSON-RPC æœåŠ¡å™¨&quot;);
    winform.txtMessage.print( wsrv.httpServer.getUrl(),&quot;å·²å¯åŠ¨ HTTPæœåŠ¡å™¨&quot;);
}
else {
    winform.txtMessage.print(&quot;å¯åŠ¨å¤±è´¥ï¼Œå»ºè®®ä¿®æ”¹ç«¯å£å·&quot;)    
}

//åŒä¸€ä¸ªç«¯å£è¿˜å¯ä»¥åŒæ—¶è¿è¡ŒHTTPæœåŠ¡ç«¯
wsrv.httpServer.run( 
    function(response,request){ 
         //response.loadcode( request.path  );
         winform.txtMessage.print(&quot;HTTPåè®®è®¿é—®ï¼š&quot;,request.url);

         loadcodex(`
        &lt;!doctype html&gt;
        &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body style=&quot;white-space:pre&quot;&gt;&lt;? 
            response.write(&quot;æ¬¢è¿ä½¿ç”¨HTTP/WebSocket/JSON-RPC ä¸‰åˆä¸€ä½“æœåŠ¡ç«¯&quot;); 
        ?&gt;&lt;/body&gt;
        &lt;/html&gt;`)
    }   
);

winform.btnPublish.oncommand = function(id,event){

    //å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼šåœ¨æŒ‡å®šé¢‘é“å‘å¸ƒæ¶ˆæ¯ï¼Œæ”¯æŒä¼ ç»™å®¢æˆ·ç«¯ä¸å®šä¸ªæ•°çš„å‚æ•°
    rpcServer.publish(&quot;serverTime&quot;,time() )
}

winform.btnSurvey.oncommand = function(id,event){

    //è°ƒæŸ¥æ¨¡å¼ï¼šå¯¹å®¢æˆ·ç«¯å‘èµ·é—®è¯¢ï¼Œæ”¯æŒä¼ ç»™å®¢æˆ·ç«¯ä¸å®šä¸ªæ•°çš„å‚æ•°
    rpcServer.survey(&quot;clientTime&quot;);

}

rpcServer.xcallback.clientTime = function(hSocket,result,err){
    winform.txtMessage.print( wsrv.getRemoteIp(hSocket) +&quot;è¿”å›è°ƒæŸ¥ç»“æœ:&quot;
        , result );
}

winform.show() 
win.loopMessage();

</code></pre>
<a href="javascript:if(confirm('https://www.aardio.com/zh-cn/doc/example/Web/WebSocket/jsonServer.md  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª Ëü²»ÔÚÏîÄ¿ÎÄ¼şÀàĞÍ¹æ·¶ÄÚ¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.aardio.com/zh-cn/doc/example/Web/WebSocket/jsonServer.md'" tppabs="https://www.aardio.com/zh-cn/doc/example/Web/WebSocket/jsonServer.md">Markdown æ ¼å¼</a>
</body> 
</html>