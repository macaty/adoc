[aardio æ–‡æ¡£](../../../../index.htm "aardio ç¼–ç¨‹è¯­è¨€æ–‡æ¡£é¦–é¡µ")

# ç¼–å†™æµè§ˆå™¨æœ¬åœ°åº”ç”¨æ‰©å±?
ä½¿ç”¨ aardio ç¼–å†™æµè§ˆå™¨æœ¬åœ°åº”ç”?(Native Messaging) æ‰©å±•åˆ†ä¸ºä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼?
1. **æœ¬åœ°æ¶ˆæ¯æœåŠ¡ç«?*ï¼šç”¨ aardio å®ç°çš„å¤šçº¿ç¨‹æœåŠ¡ç«¯ï¼Œå¯ä»¥å¤šçº¿ç¨‹æ”¶å‘æ¶ˆæ¯ï¼Œå¹¶æä¾›ç±»ä¼?WebSocket çš„å•çº¿ç¨‹å¼‚æ­¥è°ƒç”¨æ¥å£ã€?2. **æµè§ˆå™¨æ‰©å±•å®¢æˆ·ç«¯**ï¼šç”¨ JS å’?HTML ç¼–å†™çš„æ‰©å±•ç¨‹åºï¼Œç”¨äºå®ç° Native Messaging å®¢æˆ·ç«¯ã€?
## ä¸€. å‘å¸ƒå®‰è£…

#### 1\. å®‰è£…æ¶ˆæ¯æœåŠ¡ç«?
è¿è¡Œå‘å¸ƒåçš„ EXE è‡ªåŠ¨å®‰è£…æ¶ˆæ¯æœåŠ¡ç«¯ã€‚åœ¨å®‰è£…ä»£ç ä¸­é…ç½®å…è®¸è°ƒç”¨æ­¤ EXE çš„æµè§ˆå™¨æ‰©å±• IDã€?
å®‰è£…æœªæ‰“åŒ…æ‰©å±•ä¼šåŠ¨æ€ç”Ÿæˆæ‰©å±?IDï¼ˆæ¯æ¬¡éƒ½ä¼šå˜åŒ–ï¼‰ã€‚aardio å…è®¸åœ¨å‚æ•°ä¸­æŒ‡å®šæ‰©å±•ç›®å½•å¹¶è‡ªåŠ¨è·å–åŠ¨æ€ç”Ÿæˆçš„æ‰©å±• IDã€‚ç¤ºä¾‹ï¼š

```aardio aardio
web.nativeMessaging.install(
    allowed_origins = {"\crx\nativeMessagingTest"}
)

```

#### 2\. å®‰è£…æµè§ˆå™¨æ‰©å±?
åœ¨æµè§ˆå™¨æ‰©å±•ç®¡ç†é¡µé¢å¯ç”¨å¼€å‘è€…æ¨¡å¼ï¼Œå®‰è£…åŒ…å« manifest.json æ–‡ä»¶çš„æœªæ‰“åŒ…æ‰©å±•ã€?
```json json
{
    "manifest_version": 3,
    "permissions": [
        "nativeMessaging",
        "https://*/*"
    ]
}

```

## äº? Native Messaging æœåŠ¡ç«¯ç¤ºä¾?
ä»¥ä¸‹æ˜?aardio å®ç°çš?Native Messaging æœåŠ¡ç«¯ç¤ºä¾‹ä»£ç ï¼š

```aardio aardio
import win.ui;
/*DSG{{*/
var winform = win.form(text="aardioå·¥ç¨‹15";right=759;bottom=469)
winform.add(
edit={cls="edit";left=24;top=15;right=726;bottom=428;edge=1;multiline=1;z=1}
)
/*}}*/

//åˆ›å»ºæµè§ˆå™¨æœ¬åœ°æ¶ˆæ¯ä¸»æœ?import web.nativeMessaging;
var host = web.nativeMessaging();

//å¦‚æœä¸æ˜¯åœ¨æµè§ˆå™¨ä¸­å¯åŠ?host è¿”å› null
if( !host ){

    //å®‰è£…æµè§ˆå™¨æœ¬åœ°æ¶ˆæ¯ä¸»æœ?    import web.nativeMessaging.install;

    //è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶,å¹¶åœ¨æ³¨å†Œè¡¨ä¸­å†™å…¥æ­¤åº”ç”?    var json = web.nativeMessaging.install(

        //æœ¬åœ°åº”ç”¨å?å‘½åè§„åˆ™ä¸å˜é‡å‘½åè§„åˆ™ç±»ä¼¼ï¼Œåªèƒ½ä½¿ç”¨å­—æ¯æ•°å­—ï¼Œå¯ç”¨åœ†ç‚¹åˆ†éš”åç§?        name = "com.my_company.my_application";

        //è¿™ä¸ªæ˜¯æè¿°ï¼Œå…¶å®æ²¡ä»€ä¹ˆç”¨
        description = "My Application";

        //å…è®¸ä»–è°ƒç”¨æ­¤æ¶ˆæ¯ä¸»æœºçš„æµè§ˆå™¨æ‰©å±• ID æ•°ç»„
        allowed_origins = {
            "agnhjnpjidnjcppanhimaidodnbnhhbp";//å¯ä»¥æŒ‡å®šæ‰©å±• ID
            "\crx\nativeMessagingTest";//ä¹Ÿå¯ä»¥æŒ‡å®šè§£å‹çš„æ‰©å±•ç›®å½•è·¯å¾„ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºæ‰©å±• ID
            "\crx\nativeMessagingTest.pem";//ä¹Ÿå¯ä»¥æŒ‡å®šç§é’¥æ–‡ä»¶ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºæ‰©å±?ID
        }
    )

    winform.edit.print("æœ¬åœ°åº”ç”¨æœåŠ¡ç«¯å·²æ³¨å†ŒæˆåŠŸ")
    winform.edit.print(json);
}
else{

    //åœ¨Native Messagingç®¡é“ä¸­å¯åŠ?å®¢æˆ·ç«¯å·²è¿äº¤æ¥è§¦å‘æ­¤äº‹ä»¶
    host.onOpen = function(extension,parentWindow){

        winform.edit.print("å®¢æˆ·ç«¯å·²è¿æ¥ï¼?,extension)

            //ä¸èƒ½ä½¿ç”¨ win.setParent()æŠŠchromeææˆçˆ¶çª—å£ï¼Œè¿™æ ·chromeä¼šå´©æº?        win.setOwner(winform.hwnd,parentWindow);
    }

    //å®¢æˆ·ç«¯å…³é—­æ—¶è§¦å‘æ­¤äº‹ä»?    host.onClose = function(){
        winform.edit.print("å®¢æˆ·ç«¯å·²æ–­å¼€ï¼Œå³å°†é€€å‡?)
        win.quitMessage();//å¿…é¡»åŠæ—¶é€€å‡?    }

    //å®¢æˆ·ç«¯å‘äº†JSONå¯¹è±¡è¿‡æ¥ï¼Œæ³¨æ„dataæ˜¯ä¸€ä¸ªç»è¿‡JSONè§£æå¾—åˆ°çš„å¯¹è±¡ï¼Œä¸æ˜¯JSONå­—ç¬¦ä¸?    host.onMessage = function(data){
        winform.edit.print("æ”¶åˆ°æ•°æ®",data);
        host.send("è¿™æ˜¯æ¥è‡ªaardioçš„æ•°æ?);
    }

    //é‡åˆ°é”™è¯¯äº?    host.onError = function(err){
        winform.edit.print(err);
    }

    //è¿è¡Œæ¶ˆæ¯ä¸»æœº,è¿™ä¸ªå‡½æ•°åªæ˜¯å¯åŠ¨ç›‘å¬çº¿ç¨‹ï¼Œä¸ä¼šé˜»å¡?    host.run();
}

winform.show()
win.loopMessage();

```

## ä¸? æµè§ˆå™¨å®ç°çš„ Native Messaging å®¢æˆ·ç«¯ç¤ºä¾?
#### popup.html

```html html
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Native Messaging</title>
    <style>
      body {
        min-width: 300px;
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #message-form {
        display: flex;
        flex-direction: column;
      }
      input, button {
        margin: 10px 0;
      }
      button {
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:disabled {
        background-color: #ccc;
      }
    </style>
  </head>
  <body>
    <h1>Native Messaging</h1>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯">
      <button type="button" id="send-button">å‘é€æ¶ˆæ?/button>
    </form>
    <p id="msg"></p>
    <script src="popup.js"></script>
  </body>
</html>

```

#### popup.js

```javascript javascript
// è¿™é‡Œçš„å‚æ•°æ”¹ä¸ºæœ¬åœ°åº”ç”¨çš„æ ‡è¯†å?var port = chrome.runtime.connectNative('com.my_company.my_application');

// è¿æ¥æˆåŠŸåçš„å¤„ç†å‡½æ•°
function onConnected(port) {
  port.onMessage.addListener(onNativeMessage);
  port.onDisconnect.addListener(onDisconnected);
  document.getElementById('send-button').disabled = false;
}

// æœ¬åœ°åº”ç”¨æ¶ˆæ¯å¤„ç†å‡½æ•°
function onNativeMessage(msg) {
  const msgElement = document.getElementById("msg");
  if (msgElement) {
    msgElement.innerText = "æœ¬åœ°åº”ç”¨å‘è¿‡æ¥çš„å¯¹è±¡ï¼? + JSON.stringify(msg);
  }
}

// æ–­å¼€è¿æ¥å¤„ç†å‡½æ•°
function onDisconnected() {
  const msgElement = document.getElementById("msg");
  if (msgElement) {
    msgElement.innerText = "å·²æ–­å¼€è¿æ¥";
  }
  document.getElementById('send-button').disabled = true;
}

// å‘é€æ¶ˆæ¯å‡½æ•?function sendNativeMessage(message) {
  if (port) {
    port.postMessage(message);
  } else {
    console.error("æ— æ³•å‘é€æ¶ˆæ¯ï¼Œç«¯å£æœªè¿æ?);
  }
}

// å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç?document.getElementById('send-button').addEventListener('click', () => {
  const messageInput = document.getElementById('message-input');
  const messageText = messageInput.value;
  if (messageText) {
    sendNativeMessage({ text: messageText });
    messageInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡?  } else {
    alert('è¯·è¾“å…¥æ¶ˆæ?);
  }
});

// é”™è¯¯å¤„ç†
try {
  onConnected(port);
} catch (error) {
  console.error("è¿æ¥æœ¬åœ°åº”ç”¨æ—¶å‘ç”Ÿé”™è¯?", error);
}

```

#### manifest.json

```json json
{
    "manifest_version": 3,
    "name": "Native Messaging Test",
    "description": "Native Messaging",
    "version": "1.0",
    "permissions": [
        "nativeMessaging",
        "https://*/*",
        "http://*/*"
    ],
    "action": {
        "default_icon": "app.ico",
        "default_popup": "popup.html"
    }
}

```

[Markdown æ ¼å¼](javascript:if(confirm('https://www.aardio.com/zh-cn/doc/library-guide/std/web/nativeMessaging/_.md  \n\nï¿½ï¿½ï¿½Ä¼ï¿½ï¿½Ş·ï¿½ï¿½ï¿½ Teleport Ultra ï¿½ï¿½ï¿½ï¿½, ï¿½ï¿½Îª ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä¿ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½Í¹æ·¶ï¿½Ú¡ï¿½  \n\nï¿½ï¿½ï¿½ï¿½ï¿½Ú·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï´ï¿½ï¿½ï¿½ï¿½ï¿½?'))window.location='https://www.aardio.com/zh-cn/doc/library-guide/std/web/nativeMessaging/_.md')

