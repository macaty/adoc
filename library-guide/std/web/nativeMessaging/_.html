
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="robots" content="index, follow">
<meta name='description' content='aardio ç¼–ç¨‹è¯­è¨€æ–‡æ¡£ - ç¼–å†™æµè§ˆå™¨æœ¬åœ°åº”ç”¨æ‰©å±•'>
<meta http-equiv='content-language' content='zh-cn'>
<title>aardio ç¼–ç¨‹è¯­è¨€æ–‡æ¡£ - ç¼–å†™æµè§ˆå™¨æœ¬åœ°åº”ç”¨æ‰©å±•</title> 
<link rel="stylesheet" href="../../../../css/markdown.css" tppabs="https://www.aardio.com/zh-cn/doc/css/markdown.css">
<script src="../../../../js/prism.js" tppabs="https://www.aardio.com/zh-cn/doc/js/prism.js"></script>
<link rel="stylesheet" href="../../../../../../../lib.baomitu.com/font-awesome/6.6.0/css/fontawesome.min.css" tppabs="https://lib.baomitu.com/font-awesome/6.6.0/css/fontawesome.min.css">
<link rel="stylesheet" href="../../../../../../../lib.baomitu.com/font-awesome/6.6.0/css/solid.min.css" tppabs="https://lib.baomitu.com/font-awesome/6.6.0/css/solid.min.css">
</head>
<body class="markdown-body"><a id="back-to-home" href="../../../../index.htm" tppabs="https://www.aardio.com/zh-cn/doc/" title="aardio ç¼–ç¨‹è¯­è¨€æ–‡æ¡£é¦–é¡µ"><i class="fas fa-home" id="home-icon"></i><i class="fas fa-robot" id="ai-icon" style="display: none;"></i><span id="aardio-document-home">aardio æ–‡æ¡£</span></a>
<h1>ç¼–å†™æµè§ˆå™¨æœ¬åœ°åº”ç”¨æ‰©å±•</h1>

<p>ä½¿ç”¨ aardio ç¼–å†™æµè§ˆå™¨æœ¬åœ°åº”ç”¨ (Native Messaging) æ‰©å±•åˆ†ä¸ºä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p>

<ol>
<li><strong>æœ¬åœ°æ¶ˆæ¯æœåŠ¡ç«¯</strong>ï¼šç”¨ aardio å®ç°çš„å¤šçº¿ç¨‹æœåŠ¡ç«¯ï¼Œå¯ä»¥å¤šçº¿ç¨‹æ”¶å‘æ¶ˆæ¯ï¼Œå¹¶æä¾›ç±»ä¼¼ WebSocket çš„å•çº¿ç¨‹å¼‚æ­¥è°ƒç”¨æ¥å£ã€‚</li>
<li><strong>æµè§ˆå™¨æ‰©å±•å®¢æˆ·ç«¯</strong>ï¼šç”¨ JS å’Œ HTML ç¼–å†™çš„æ‰©å±•ç¨‹åºï¼Œç”¨äºå®ç° Native Messaging å®¢æˆ·ç«¯ã€‚</li>
</ol>

<h2>ä¸€. å‘å¸ƒå®‰è£…</h2>

<h4>1. å®‰è£…æ¶ˆæ¯æœåŠ¡ç«¯</h4>

<p>è¿è¡Œå‘å¸ƒåçš„ EXE è‡ªåŠ¨å®‰è£…æ¶ˆæ¯æœåŠ¡ç«¯ã€‚åœ¨å®‰è£…ä»£ç ä¸­é…ç½®å…è®¸è°ƒç”¨æ­¤ EXE çš„æµè§ˆå™¨æ‰©å±• IDã€‚</p>

<p>å®‰è£…æœªæ‰“åŒ…æ‰©å±•ä¼šåŠ¨æ€ç”Ÿæˆæ‰©å±• IDï¼ˆæ¯æ¬¡éƒ½ä¼šå˜åŒ–ï¼‰ã€‚aardio å…è®¸åœ¨å‚æ•°ä¸­æŒ‡å®šæ‰©å±•ç›®å½•å¹¶è‡ªåŠ¨è·å–åŠ¨æ€ç”Ÿæˆçš„æ‰©å±• IDã€‚ç¤ºä¾‹ï¼š</p>

<pre><code class="aardio language-aardio">web.nativeMessaging.install(
    allowed_origins = {&quot;\crx\nativeMessagingTest&quot;} 
)
</code></pre>

<h4>2. å®‰è£…æµè§ˆå™¨æ‰©å±•</h4>

<p>åœ¨æµè§ˆå™¨æ‰©å±•ç®¡ç†é¡µé¢å¯ç”¨å¼€å‘è€…æ¨¡å¼ï¼Œå®‰è£…åŒ…å« manifest.json æ–‡ä»¶çš„æœªæ‰“åŒ…æ‰©å±•ã€‚</p>

<pre><code class="json language-json">{
    &quot;manifest_version&quot;: 3, 
    &quot;permissions&quot;: [
        &quot;nativeMessaging&quot;,
        &quot;https://*/*&quot; 
    ] 
}
</code></pre>

<h2>äºŒ. Native Messaging æœåŠ¡ç«¯ç¤ºä¾‹</h2>

<p>ä»¥ä¸‹æ˜¯ aardio å®ç°çš„ Native Messaging æœåŠ¡ç«¯ç¤ºä¾‹ä»£ç ï¼š</p>

<pre><code class="aardio language-aardio">import win.ui;
/*DSG{{*/
var winform = win.form(text=&quot;aardioå·¥ç¨‹15&quot;;right=759;bottom=469)
winform.add(
edit={cls=&quot;edit&quot;;left=24;top=15;right=726;bottom=428;edge=1;multiline=1;z=1}
)
/*}}*/

//åˆ›å»ºæµè§ˆå™¨æœ¬åœ°æ¶ˆæ¯ä¸»æœº
import web.nativeMessaging;
var host = web.nativeMessaging();

//å¦‚æœä¸æ˜¯åœ¨æµè§ˆå™¨ä¸­å¯åŠ¨ host è¿”å› null
if( !host ){

    //å®‰è£…æµè§ˆå™¨æœ¬åœ°æ¶ˆæ¯ä¸»æœº
    import web.nativeMessaging.install;

    //è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶,å¹¶åœ¨æ³¨å†Œè¡¨ä¸­å†™å…¥æ­¤åº”ç”¨
    var json = web.nativeMessaging.install(

        //æœ¬åœ°åº”ç”¨å,å‘½åè§„åˆ™ä¸å˜é‡å‘½åè§„åˆ™ç±»ä¼¼ï¼Œåªèƒ½ä½¿ç”¨å­—æ¯æ•°å­—ï¼Œå¯ç”¨åœ†ç‚¹åˆ†éš”åç§°
        name = &quot;com.my_company.my_application&quot;;

        //è¿™ä¸ªæ˜¯æè¿°ï¼Œå…¶å®æ²¡ä»€ä¹ˆç”¨
        description = &quot;My Application&quot;;

        //å…è®¸ä»–è°ƒç”¨æ­¤æ¶ˆæ¯ä¸»æœºçš„æµè§ˆå™¨æ‰©å±• ID æ•°ç»„
        allowed_origins = {
            &quot;agnhjnpjidnjcppanhimaidodnbnhhbp&quot;;//å¯ä»¥æŒ‡å®šæ‰©å±• ID
            &quot;\crx\nativeMessagingTest&quot;;//ä¹Ÿå¯ä»¥æŒ‡å®šè§£å‹çš„æ‰©å±•ç›®å½•è·¯å¾„ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºæ‰©å±• ID
            &quot;\crx\nativeMessagingTest.pem&quot;;//ä¹Ÿå¯ä»¥æŒ‡å®šç§é’¥æ–‡ä»¶ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºæ‰©å±• ID
        }
    )

    winform.edit.print(&quot;æœ¬åœ°åº”ç”¨æœåŠ¡ç«¯å·²æ³¨å†ŒæˆåŠŸ&quot;)
    winform.edit.print(json); 
}
else{

    //åœ¨Native Messagingç®¡é“ä¸­å¯åŠ¨,å®¢æˆ·ç«¯å·²è¿äº¤æ¥è§¦å‘æ­¤äº‹ä»¶
    host.onOpen = function(extension,parentWindow){

        winform.edit.print(&quot;å®¢æˆ·ç«¯å·²è¿æ¥ï¼š&quot;,extension)

            //ä¸èƒ½ä½¿ç”¨ win.setParent()æŠŠchromeææˆçˆ¶çª—å£ï¼Œè¿™æ ·chromeä¼šå´©æºƒ
        win.setOwner(winform.hwnd,parentWindow);
    }

    //å®¢æˆ·ç«¯å…³é—­æ—¶è§¦å‘æ­¤äº‹ä»¶
    host.onClose = function(){
        winform.edit.print(&quot;å®¢æˆ·ç«¯å·²æ–­å¼€ï¼Œå³å°†é€€å‡º&quot;)
        win.quitMessage();//å¿…é¡»åŠæ—¶é€€å‡º
    }

    //å®¢æˆ·ç«¯å‘äº†JSONå¯¹è±¡è¿‡æ¥ï¼Œæ³¨æ„dataæ˜¯ä¸€ä¸ªç»è¿‡JSONè§£æå¾—åˆ°çš„å¯¹è±¡ï¼Œä¸æ˜¯JSONå­—ç¬¦ä¸²
    host.onMessage = function(data){
        winform.edit.print(&quot;æ”¶åˆ°æ•°æ®&quot;,data);
        host.send(&quot;è¿™æ˜¯æ¥è‡ªaardioçš„æ•°æ®&quot;);
    }

    //é‡åˆ°é”™è¯¯äº†
    host.onError = function(err){
        winform.edit.print(err);
    }

    //è¿è¡Œæ¶ˆæ¯ä¸»æœº,è¿™ä¸ªå‡½æ•°åªæ˜¯å¯åŠ¨ç›‘å¬çº¿ç¨‹ï¼Œä¸ä¼šé˜»å¡
    host.run();
}

winform.show() 
win.loopMessage();
</code></pre>

<h2>ä¸‰. æµè§ˆå™¨å®ç°çš„ Native Messaging å®¢æˆ·ç«¯ç¤ºä¾‹</h2>

<h4>popup.html</h4>

<pre><code class="html language-html">&lt;!doctype html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;Native Messaging&lt;/title&gt;
    &lt;style&gt;
      body {
        min-width: 300px;
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #message-form {
        display: flex;
        flex-direction: column;
      }
      input, button {
        margin: 10px 0;
      }
      button {
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:disabled {
        background-color: #ccc;
      }
    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Native Messaging&lt;/h1&gt;
    &lt;form id=&quot;message-form&quot;&gt;
      &lt;input type=&quot;text&quot; id=&quot;message-input&quot; placeholder=&quot;è¾“å…¥æ¶ˆæ¯&quot;&gt;
      &lt;button type=&quot;button&quot; id=&quot;send-button&quot;&gt;å‘é€æ¶ˆæ¯&lt;/button&gt;
    &lt;/form&gt;
    &lt;p id=&quot;msg&quot;&gt;&lt;/p&gt;
    &lt;script src=&quot;popup.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h4>popup.js</h4>

<pre><code class="javascript language-javascript">// è¿™é‡Œçš„å‚æ•°æ”¹ä¸ºæœ¬åœ°åº”ç”¨çš„æ ‡è¯†å
var port = chrome.runtime.connectNative(&#39;com.my_company.my_application&#39;);

// è¿æ¥æˆåŠŸåçš„å¤„ç†å‡½æ•°
function onConnected(port) {
  port.onMessage.addListener(onNativeMessage);
  port.onDisconnect.addListener(onDisconnected);
  document.getElementById(&#39;send-button&#39;).disabled = false;
}

// æœ¬åœ°åº”ç”¨æ¶ˆæ¯å¤„ç†å‡½æ•°
function onNativeMessage(msg) {
  const msgElement = document.getElementById(&quot;msg&quot;);
  if (msgElement) {
    msgElement.innerText = &quot;æœ¬åœ°åº”ç”¨å‘è¿‡æ¥çš„å¯¹è±¡ï¼š&quot; + JSON.stringify(msg);
  }
}

// æ–­å¼€è¿æ¥å¤„ç†å‡½æ•°
function onDisconnected() {
  const msgElement = document.getElementById(&quot;msg&quot;);
  if (msgElement) {
    msgElement.innerText = &quot;å·²æ–­å¼€è¿æ¥&quot;;
  }
  document.getElementById(&#39;send-button&#39;).disabled = true;
}

// å‘é€æ¶ˆæ¯å‡½æ•°
function sendNativeMessage(message) {
  if (port) {
    port.postMessage(message);
  } else {
    console.error(&quot;æ— æ³•å‘é€æ¶ˆæ¯ï¼Œç«¯å£æœªè¿æ¥&quot;);
  }
}

// å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
document.getElementById(&#39;send-button&#39;).addEventListener(&#39;click&#39;, () =&gt; {
  const messageInput = document.getElementById(&#39;message-input&#39;);
  const messageText = messageInput.value;
  if (messageText) {
    sendNativeMessage({ text: messageText });
    messageInput.value = &#39;&#39;; // æ¸…ç©ºè¾“å…¥æ¡†
  } else {
    alert(&#39;è¯·è¾“å…¥æ¶ˆæ¯&#39;);
  }
});

// é”™è¯¯å¤„ç†
try {
  onConnected(port);
} catch (error) {
  console.error(&quot;è¿æ¥æœ¬åœ°åº”ç”¨æ—¶å‘ç”Ÿé”™è¯¯:&quot;, error);
}
</code></pre>

<h4>manifest.json</h4>

<pre><code class="json language-json">{
    &quot;manifest_version&quot;: 3,
    &quot;name&quot;: &quot;Native Messaging Test&quot;,
    &quot;description&quot;: &quot;Native Messaging&quot;,
    &quot;version&quot;: &quot;1.0&quot;,
    &quot;permissions&quot;: [
        &quot;nativeMessaging&quot;,
        &quot;https://*/*&quot;,
        &quot;http://*/*&quot;
    ],
    &quot;action&quot;: {
        &quot;default_icon&quot;: &quot;app.ico&quot;,
        &quot;default_popup&quot;: &quot;popup.html&quot;
    }
}
</code></pre>

<p><a href="javascript:if(confirm('https://www.aardio.com/zh-cn/doc/library-guide/std/web/nativeMessaging/_.md  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª Ëü²»ÔÚÏîÄ¿ÎÄ¼şÀàĞÍ¹æ·¶ÄÚ¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.aardio.com/zh-cn/doc/library-guide/std/web/nativeMessaging/_.md'" tppabs="https://www.aardio.com/zh-cn/doc/library-guide/std/web/nativeMessaging/_.md">Markdown æ ¼å¼</a></p>

</body> 
</html>